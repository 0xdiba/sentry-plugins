{% extends 'base.html' %}

{% block content %}
  <div id="reporter"></div>
  <ul id="sentry-issues">
  </ul>
{% endblock %}
{% block javascript %}
  <script type="text/x-template" title="reporter-template">
    <div class="reporter">
      <img src="{avatarURL}"/>
      <span><strong>{email}</strong> experienced {count} issues:</span>
    </div>
  </script>
  <script type="text/x-template" title="issue-template">
    <li class="aui-group">
      <div class="aui-item error-level">
        <span class="sentry-{level}"></span>
      </div>
      <div class="aui-item">
        <div><a href="{permalink}" target="_blank">{title}</a></div>
        <div class="last-seen">Last seen: {lastSeen}</div>
      </div>
    </li>
  </script>
  <script type="text/javascript">
    (function() {
      var issueKey = '{{ issue_key }}';
      var MAX_ISSUES = 5;
      AP.require('request', function(request) {
        request({
          url: '/rest/api/latest/issue/' + issueKey,
          success: function(responseText) {
            var issue = JSON.parse(responseText);
            var reporter = issue.fields.reporter;
            var email = reporter.emailAddress;
            var url = ('{{ sentry_api_url }}' + '?limit=' + (MAX_ISSUES + 1) + '&email=' +
                       encodeURIComponent(email));
            $.get(url).done(function(issues) {
              var $issuesEl = $('#sentry-issues');
              var $reporter = $('#reporter');
              $reporter.append(AJS.template.load('reporter-template').fill({
                avatarURL: reporter.avatarUrls['24x24'],
                email: email,
                count: issues.length > MAX_ISSUES ? '5+' : issues.length
              }));
              for (var i = 0; i < Math.min(issues.length, MAX_ISSUES); i++) {
                var issue = issues[i];
                var level = issue.level;
                $issuesEl.append(AJS.template.load('issue-template').fill({
                  level: level === 'fatal' ? 'error' : level,
                  permalink: issue.permalink,
                  title: issue.title,
                  lastSeen: prettyDate(issue.lastSeen) || ''
                }));
              }
            }).fail(function() {
              $('#reporter').text('Unable to fetch related issues. Please try again.')
            });
          }
        });
      });
    })();
  </script>
{% endblock %}
